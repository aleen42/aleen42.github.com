var time={texts:{},start:function(b){this.texts[b]=new Date().valueOf()},end:function(c){var d=new Date().valueOf()-this.texts[c];this.mark(c+': <span class="font-a10000 font-bold">'+d+"</span> ms")},mark:function(f,e){e=e||null;if(e===null||typeof this.texts[e]==="undefined"){var d=document.createElement("p");d.className="paragraph-padding";d.innerHTML=f;document.querySelectorAll(".container__info")[0].appendChild(d);this.texts[e]=d}else{this.texts[e].innerHTML=f}},clear:function(){this.texts={}}};var pathConverter={convertCE:function(e,f){function d(j,a,b,c){if(j<0||a<0||b<=0||c<=0){return""}var i="M"+(j-b).toString()+","+a.toString();i+="a"+b.toString()+","+c.toString()+" 0 1,0 "+(2*b).toString()+",0";i+="a"+b.toString()+","+c.toString()+" 0 1,0"+(-2*b).toString()+",0";return i}switch(arguments.length){case 3:return d(parseFloat(e,10),parseFloat(f,10),parseFloat(arguments[2],10),parseFloat(arguments[2],10));case 4:return d(parseFloat(e,10),parseFloat(f,10),parseFloat(arguments[2],10),parseFloat(arguments[3],10));break;default:return""}},convertPoly:function(k,l){l=l||"polyline";var i=k.split("	").join("").trim().split(/\s+|,/);var g=i.shift();var j=i.shift();var h="M"+g+","+j+"L"+i.join(" ");return l==="polygon"?h+"z":h},convertLine:function(e,g,f,h){if(parseFloat(e,10)<0||parseFloat(g,10)<0||parseFloat(f,10)<0||parseFloat(h,10)<0){return""}return"M"+e+","+g+"L"+f+","+h},convertRectangles:function(e,g,h,f){var e=parseFloat(e,10);var g=parseFloat(g,10);var h=parseFloat(h,10);var f=parseFloat(f,10);if(e<0||g<0||h<0||f<0){return""}return"M"+e+","+g+"L"+(e+h)+","+g+" "+(e+h)+","+(g+f)+" "+e+","+(g+f)+"z"}};var canvasObj={instance:null,imgs:[],fixedDrag:false,stage:null,layer:null,canvas:null,contourFinder:null,capturer:null,pathSum:0,pointSum:0,contextStates:null,init:function(f,j,g){this.stage=new Konva.Stage({container:f,width:j,height:g});var h=false;this.layer=new Konva.Layer();this.layer.canvas._canvas.className="canvas__panel";this.stage.add(this.layer);this.instance=this.layer.canvas._canvas;if(this.instance.addEventListener){document.onkeydown=function(a){var b=a.which||a.keyCode;if(b===16){this.fixedDrag=true}}.bind(this);document.onkeyup=function(a){var b=a.which||a.keyCode;if(b===16){this.fixedDrag=false}}.bind(this);var i=document.createElement("div");i.className="notice__drop";i.innerText="Drop the image";this.instance.parentElement.appendChild(i);this.instance.addEventListener("dragover",function(a){a.preventDefault();if(!h){i.style.opacity=1;h=true}},false);this.instance.addEventListener("dragleave",function(a){a.preventDefault();if(h){i.style.opacity=0;h=false}},false);this.instance.addEventListener("drop",function(b){if(h){i.style.opacity=0;h=false}var c=b.dataTransfer.files;if(c.length>0){var d=c[0];if(typeof FileReader!=="undefined"&&d.type.indexOf("image")!==-1){var e=new FileReader();var a=new FileReader();e.onload=function(m){var n=document.createElement("img");n.addEventListener("load",function(){const z=n.width/n.height;const v=0.8;var w=n.width;var k=n.height;if(n.width>v*parseInt(this.instance.getAttribute("width"))||n.height>v*parseInt(this.instance.getAttribute("height"))){const l=z/(parseInt(this.instance.getAttribute("width"))/parseInt(this.instance.getAttribute("height")));w=l<1?v*parseInt(this.instance.getAttribute("height"))*z:v*parseInt(this.instance.getAttribute("width"));k=l<1?v*parseInt(this.instance.getAttribute("height")):v*parseInt(this.instance.getAttribute("width"))/z}var u=new Konva.Image({width:w,height:k});u.on("mouseout",function(){document.body.style.cursor="default"});u.image(n);var x=new Konva.Group({x:(parseInt(this.instance.getAttribute("width"))-w)/2,y:(parseInt(this.instance.getAttribute("height"))-k)/2,draggable:true});x.add(u);this.addAnchor(x,0,0,"topLeft");this.addAnchor(x,w,0,"topRight");this.addAnchor(x,0,k,"bottomLeft");this.addAnchor(x,w,k,"bottomRight");x.on("dragmove",function(){var r=this.layer.get("Group");var o=r.length;for(var q=0;q<o;q++){r[q].opacity(1)}this.layer.draw();for(var q=0;q<x.children.length;q++){var p=x.children[q];if(p.className==="Circle"){if(p.attrs.visible===false){p.show();this.layer.draw()}}}}.bind(this));this.layer.add(x);this.layer.draw();var y=this.imgs.push({group:x,oriX:(parseInt(this.instance.getAttribute("width"))-w)/2,oriY:(parseInt(this.instance.getAttribute("height"))-k)/2,oriW:w,oriH:k,isSVG:false,svgPaths:[]})-1;a.onload=(function(o){return function(r){var Q=[];var V=document.createElement("div");V.innerHTML=r.target.result.trim().split("\n").join("").split("	").join("");var P=V.childNodes;var R=P.length;var S=window.innerWidth;var Y=window.innerHeight;var W=0;var X=0;var U=S;var p=Y;var N=function(A){var B=document.createElementNS("http://www.w3.org/2000/svg","path");B.setAttribute("d",A);return B};var Z=function(C){var L=C.childNodes;var A=L.length;var F=this.imgs[y];if(A===0){return}for(var I=0;I<A;I++){switch(L[I].nodeName){case"path":var G=L[I].getAttribute("d");var K=G.match(/m[\s\S]+?(?=(?:m|$)+)/ig);var B=K.length;
var D=0;var E=0;for(var J=0;J<B;J++){var H=K[J][0];K[J]=K[J].slice(1);if(B>1){K[J]=K[J].replace(/((?:-)*\d+(?:\.(?:\d+))*)([ ,]*)((?:-)*\d+(?:\.(?:\d+))*)(.*)/,function(ae,M,ad,ag,af){M=parseFloat(M);ag=parseFloat(ag);ad=ad===""?" ":ad;if(D===0&&E===0){D=M;E=ag;return D+ad+E+af}if(H==="M"){D=M;E=ag;return D+ad+E+af}D+=parseFloat(M);E+=parseFloat(ag);return D+ad+E+af})}Q.push(N("M"+K[J].trim()))}break;case"circle":Q.push(N(pathConverter.convertCE(L[I].getAttribute("cx"),L[I].getAttribute("cy"),L[I].getAttribute("r"))));break;case"ellipse":Q.push(N(pathConverter.convertCE(L[I].getAttribute("cx"),L[I].getAttribute("cy"),L[I].getAttribute("rx"),L[I].getAttribute("ry"))));break;case"polygon":Q.push(N(pathConverter.convertPoly(L[I].getAttribute("points"),"polygon")));break;case"polyline":Q.push(N(pathConverter.convertPoly(L[I].getAttribute("points"))));break;case"line":Q.push(N(pathConverter.convertLine(L[I].getAttribute("x1"),L[I].getAttribute("y1"),L[I].getAttribute("x2"),L[I].getAttribute("y2"))));break;case"rect":Q.push(N(pathConverter.convertRectangles(L[I].getAttribute("x"),L[I].getAttribute("y"),L[I].getAttribute("width"),L[I].getAttribute("height"))));break;default:break}Z(L[I])}}.bind(this);for(var q=0;q<R;q++){if(P[q].nodeName==="svg"){var t=P[q].getAttribute("width");var T=P[q].getAttribute("height");var s=P[q].getAttribute("viewBox");if(t){S=parseFloat(t.split("px").join(""),10);U=S}if(T){Y=parseFloat(T.split("px").join(""),10);p=Y}if(s){W=parseFloat(s.split(" ")[0],10);X=parseFloat(s.split(" ")[1],10);U=parseFloat(s.split(" ")[2],10);p=parseFloat(s.split(" ")[3],10)}Z(P[q])}}if(Q.length!==0){var O=this.imgs[y];O.isSVG=true;O.svgPaths=Q;O.svgW=S;O.svgH=Y;O.viewBoxX=W;O.viewBoxY=X;O.viewBoxW=U;O.viewBoxH=p}}.bind(o)})(this);a.readAsText(d);u.on("mouseover",function(){document.body.style.cursor="move"}.bind(this))}.bind(this),false);n.src=m.target.result}.bind(this);e.readAsDataURL(d)}}b.preventDefault()}.bind(this))}else{if(this.instance.attachEvent){}}},addAnchor:function(i){var f=i.getStage();var j=i.getLayer();var g=arguments.length===4?new Konva.Circle({x:arguments[1],y:arguments[2],stroke:"#666",fill:"#ddd",strokeWidth:2,radius:8,name:arguments[3],draggable:true,dragOnTop:false}):arguments[1];var h=function(v){var e=1;var c=v.getParent();var b=c.get(".topLeft")[0];var s=c.get(".topRight")[0];var r=c.get(".bottomRight")[0];var d=c.get(".bottomLeft")[0];var t=c.get("Image")[0];t.position(b.position());var u=v.getX();var w=v.getY();switch(v.getName()){case"topLeft":var a=d.getY()-b.getY();var x=this.fixedDrag?a*t.attrs.width/t.attrs.height:s.getX()-b.getX();d.setX(this.fixedDrag?r.getX()-x:u);t.position({x:r.position().x-x,y:r.position().y-a});if(this.fixedDrag){b.setX(s.getX()-x)}s.setY(w);break;case"topRight":var a=d.getY()-b.getY();var x=this.fixedDrag?a*t.attrs.width/t.attrs.height:s.getX()-b.getX();r.setX(this.fixedDrag?d.getX()+x:u);if(this.fixedDrag){s.setX(b.getX()+x)}b.setY(w);break;case"bottomRight":var x=s.getX()-b.getX();var a=this.fixedDrag?x*t.attrs.height/t.attrs.width:d.getY()-b.getY();d.setY(this.fixedDrag?b.getY()+a:w);if(this.fixedDrag){r.setY(s.getY()+a)}s.setX(u);break;case"bottomLeft":var x=s.getX()-b.getX();var a=this.fixedDrag?x*t.attrs.height/t.attrs.width:d.getY()-b.getY();r.setY(this.fixedDrag?s.getY()+a:w);if(this.fixedDrag){d.setY(b.getY()+a)}b.setX(u);break}if(x&&a){t.width(x);t.height(a)}}.bind(this);g.on("dragmove",function(){h(g);this.layer.draw()}.bind(this));g.on("mousedown touchstart",function(){i.setDraggable(false);this.moveToTop()});g.on("dragend",function(){i.setDraggable(true);this.layer.draw()}.bind(this));g.on("mouseover",function(){var a=this.getLayer();document.body.style.cursor="pointer";g.setStrokeWidth(4);a.draw()});g.on("mouseout",function(){var a=this.getLayer();document.body.style.cursor="default";this.setStrokeWidth(2);a.draw()});i.add(g)},clearCanvas:function(d,e,f){d=d||this.instance.getContext("2d");e=e||this.instance.width;f=f||this.instance.height;d.clearRect(0,0,e,f)},process:function(ad,L){time.clear();var l=this.layer.get("Group");for(var V=0;V<l.length;V++){l[V].opacity(1)}this.layer.draw();var K=this.imgs.length;time.start("Find Contours");for(var V=0;V<K;V++){if(!this.imgs[V].isSVG){this.canvas=new Canvas(this.instance,parseInt(this.instance.getAttribute("width")),parseInt(this.instance.getAttribute("height")));var ac=new Canny(this.canvas);var Z=new Filters(this.canvas);this.contourFinder=new ContourFinder();time.start("Gray Scale");this.canvas.setImgData(Z.grayscale());time.end("Gray Scale");time.start("Gaussian Blur");this.canvas.setImgData(Z.gaussianBlur(5,1));time.end("Gaussian Blur");time.start("Canny Grdient");this.canvas.setImgData(ac.gradient("sobel"));time.end("Canny Grdient");time.start("Canny non-Maximum Suppress");this.canvas.setImgData(ac.nonMaximumSuppress());time.end("Canny non-Maximum Suppress");time.start("Canny Hysteresis");this.canvas.setImgData(ac.hysteresis());time.end("Canny Hysteresis");break}}for(var V=0;V<K;V++){var J=0;
var d=this.imgs[V];var af=d.group;var Y=af.attrs.x;var aa=af.attrs.y;var M=af.get("Image")[0];var N=M.attrs.x;var R=M.attrs.y;if(!d.isSVG){this.contourFinder.init(this.canvas.getCanvas(),Y+(typeof N==="undefined"?0:N)-J,aa+(typeof tgroupImgY==="undefined"?0:R)-J,M.attrs.width+J*2,M.attrs.height+J*2);var W=this.contourFinder.findContours();this.pathSum+=W.length;d.paths=W}else{d.dx=Y+(typeof N==="undefined"?0:N)-J;d.dy=aa+(typeof R==="undefined"?0:R)-J;this.pathSum+=d.svgPaths.length;d.paths=d.svgPaths}}time.end("Find Contours");time.mark('Contour Number: <span class="font-a10000 font-bold">'+this.pathSum+"</span>");var P=[];var U=0;var X=0;for(var k=0;k<K;k++){var d=this.imgs[k];var Q=d.paths.length;P[k]=[];for(var I=0;I<Q;I++){if(!d.isSVG){var T=document.createElementNS("http://www.w3.org/2000/svg","path");var i=d.paths[I];var S=i.length;var O="M";for(var j=0;j<S;j+=1){O+=(i[j].x+U)+","+(i[j].y+X)+"  ";this.pointSum++}T.setAttribute("d",O.trim());P[k].push(T)}else{P[k].push(d.paths[I])}}}ad();if(P.length!==0){var ae=document.getElementById("process__type");var ab=ae.options[ae.selectedIndex].value;switch(ab){case"preview":time.start("Draw");this.preview(P,L);break;case"save":time.start("Draw");this.save(P,L);break;default:break}}},preview:function(d,c){this.drawContours(this.canvas,d,c)},save:function(d,c){this.drawContours(this.canvas,d,c,true)},canvasSaveState:function(e,c){if(c){f=c;f.getContext("2d").drawImage(e.canvas,0,0)}else{var f=document.createElement("canvas");f.width=e.canvas.width;f.height=e.canvas.height;f.getContext("2d").drawImage(e.canvas,0,0)}return f},canvasRestoreState:function(d,c){if(c){d.drawImage(c,0,0)}},drawContours:function(D,r,t,C){C=C||false;this.contextStates=null;for(var y=0;y<r.length;y++){r[y].sort(function(b,a){return a.getTotalLength()-b.getTotalLength()})}this.clearCanvas();var u=this.layer.getContext();var i=function(b,c){var d=this.layer.get("Group");for(var a=0;a<d.length;a++){if(a>c){d[a].opacity(0)}}d[c].opacity(b);this.layer.draw();if(this.contextStates){this.canvasRestoreState(u._context,this.contextStates)}}.bind(this);var s=8;var z=1000;var w=[];var E;if(C&&!this.capturer){this.capturer=new CCapture({verbose:false,display:false,framerate:z,format:"webm",frameLimit:0,bakckgroundColor:"#fff",onProcess:function(a){time.mark('Capturing Frame Number: <span class="font-a10000 font-bold">'+a+"</span>","frameCount")}})}var v=0.5;var B=null;var F={x:63,y:208,ele:document.getElementById("nib")};var A=function(d){this.clearCanvas();var b=this.imgs[d];var f=b.group;var c=f.get("Image")[0];var j=f.attrs.x;var a=f.attrs.y;var e=c.attrs.x;var g=c.attrs.y;u.beginPath();u.moveTo(w[0].x,w[0].y);for(var h=1;h<w.length;h++){u.lineTo(w[h].x,w[h].y)}if(B){this.canvasRestoreState(u._context,B)}u.stroke();B=this.canvasSaveState(u._context,B);if(this.contextStates){u.drawImage(this.contextStates,0,0)}u.drawImage(F.ele,w[h-1].x-F.x,w[h-1].y-F.y);if(this.capturer){this.capturer.capture(this.instance)}}.bind(this);var x=function(p){if(this.capturer){this.capturer.capture(this.instance)}if(B){if(this.contextStates){this.contextStates.getContext("2d").drawImage(B,0,0)}else{this.contextStates=B}}var n=0;for(var h=0;h<r.length;h++){n+=r[h].length}time.mark('Process: <span class="font-a10000 font-bold">'+((this.pathSum-n)/this.pathSum*98).toFixed(2)+"%</span>","process");if(r[p].length===0){var e=document.getElementById("process__draw-color").checked;var O=0;if(C){var l=function(){O+=e?0.05:1;i(e?O:0,p);if(this.capturer){this.capturer.capture(this.instance)}if(O>=1){if(typeof r[p+1]!=="undefined"){if(this.contextStates){this.contextStates.getContext("2d").drawImage(u._context.canvas,0,0)}x(p+1)}else{if(this.capturer){this.capturer.stop();this.capturer.save();this.capturer=null}time.end("Draw");t();time.mark('Process: <span class="font-a10000 font-bold">100%</span>',"process")}}else{requestAnimationFrame(l)}}.bind(this);l()}else{var P=setInterval(function(){O+=e?0.05:1;i(e?O:0,p);if(O>=1){if(typeof r[p+1]!=="undefined"){if(this.contextStates){this.contextStates.getContext("2d").drawImage(u._context.canvas,0,0)}x(p+1)}else{time.end("Draw");t();time.mark('Process: <span class="font-a10000 font-bold">100%</span>',"process")}clearInterval(P)}}.bind(this),1000/z)}return}var M=r[p].splice(0,1);B=null;u.lineWidth=v;u.strokeStyle="#000";var k=this.imgs[p];var b=M[0].getTotalLength();var o=200;var N=3;var a=8;s=Math.ceil(k.isSVG?(b/o>a?a:(b/o<N?N:b/o)):s);var c=k.dx;var g=k.dy;var j=k.group.get("Image")[0].attrs.width;var m=k.group.get("Image")[0].attrs.height;w=[];var d=function(I,J){var U=J.group.get("Image")[0];if(J.isSVG){var L=J.dx;var T=J.dy;var K=Math.max(J.oriW/J.svgW,J.oriH/J.svgH)*Math.min(J.svgW/J.viewBoxW,J.svgH/J.viewBoxH);var H=(U.attrs.width/J.oriW)*K;var G=(U.attrs.height/J.oriH)*K;I.x=I.x*H+L-J.viewBoxX*H;I.y=I.y*G+T-J.viewBoxY*G;I.x=I.x>=L&&I.x<=L+j?I.x:((I.x<L)?L:L+j);I.y=I.y>=T&&I.y<=T+m?I.y:((I.y<T)?T:T+m);w.push(I)}else{w.push(I)}}.bind(this);if(this.capturer){var q=0;
var Q=function(){var H=q++*s;if(H<=b){var G=M[0].getPointAtLength(H);d(G,k);A(p);requestAnimationFrame(Q)}else{x(p)}};Q()}else{var q=0;var f=setInterval(function(){var H=q++*s;if(H<=b){var G=M[0].getPointAtLength(H);d(G,k);A(p)}else{clearInterval(f);x(p)}},1000/z)}}.bind(this);if(C){this.capturer.start()}x(0)}};(function(){const m=73;const r=window.innerWidth;const q=window.navigator.userAgent.toLowerCase().indexOf("micromessenger")>-1?window.innerHeight-m:window.innerHeight;document.querySelectorAll(".container")[0].style.height=q+"px";canvasObj.init(document.querySelectorAll(".container")[0],r-13*2-350,q*6/7);var o=document.getElementById("process__button");var l=document.getElementById("clear__button");var s=document.getElementById("process__draw-color");var p=document.querySelectorAll(".checkbox__color")[0];var t=function(){Object.assign(canvasObj,{canvas:null,contourFinder:null,pathSum:0,pointSum:0,contextStates:null});o.className="button button__inline button__disabled";o.removeEventListener("click",t);l.className="button button__inline button__disabled";l.removeEventListener("click",k);setTimeout(function(){var e=console;var c=document.querySelectorAll(".container__info")[0];var a=c.children.length;for(var b=0;b<a;b++){c.removeChild(c.children[0])}var d=new Promise(function(){for(var j=0;j<canvasObj.imgs.length;j++){var g=canvasObj.imgs[j].group.children.length;var h=0;for(var i=0;i<g;i++){var f=canvasObj.imgs[j].group.children[i];if(f.className==="Circle"){f.hide();canvasObj.layer.draw()}else{h++}}}canvasObj.process(function(){o.className="button button__inline";o.addEventListener("click",t)},function(){l.className="button button__inline";l.addEventListener("click",k)})})},500)};var k=function(){Object.assign(canvasObj,{imgs:[],canvas:null,contourFinder:null,pathSum:0,pointSum:0,contextStates:null});canvasObj.layer.destroyChildren().draw()};var n=function(){s.checked=!s.checked;p.className=!s.checked?"checkbox__color":"checkbox__color checkbox__color-selected"};o.addEventListener("click",t);l.addEventListener("click",k);p.addEventListener("click",n);s.addEventListener("change",function(){p.className=!this.checked?"checkbox__color":"checkbox__color checkbox__color-selected"})})();