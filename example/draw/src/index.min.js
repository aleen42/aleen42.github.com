var time={texts:{},start:function(b){this.texts[b]=new Date().valueOf()},end:function(c){var d=new Date().valueOf()-this.texts[c];this.mark(c+': <span class="font-a10000 font-bold">'+d+"</span> ms")},mark:function(f,e){e=e||null;if(e===null||typeof this.texts[e]==="undefined"){var d=document.createElement("p");d.className="paragraph-padding";d.innerHTML=f;document.querySelectorAll(".container__info")[0].appendChild(d);this.texts[e]=d}else{this.texts[e].innerHTML=f}},clear:function(){this.texts={}}};var pathConverter={convertCE:function(e,f){function d(j,a,b,c){if(j<0||a<0||b<=0||c<=0){return""}var i="M"+(j-b).toString()+","+a.toString();i+="a"+b.toString()+","+c.toString()+" 0 1,0 "+(2*b).toString()+",0";i+="a"+b.toString()+","+c.toString()+" 0 1,0"+(-2*b).toString()+",0";return i}switch(arguments.length){case 3:return d(parseFloat(e,10),parseFloat(f,10),parseFloat(arguments[2],10),parseFloat(arguments[2],10));case 4:return d(parseFloat(e,10),parseFloat(f,10),parseFloat(arguments[2],10),parseFloat(arguments[3],10));break;default:return""}},convertPoly:function(k,l){l=l||"polyline";var i=k.split("	").join("").trim().split(/\s+|,/);var g=i.shift();var j=i.shift();var h="M"+g+","+j+"L"+i.join(" ");return l==="polygon"?h+"z":h},convertLine:function(e,g,f,h){if(parseFloat(e,10)<0||parseFloat(g,10)<0||parseFloat(f,10)<0||parseFloat(h,10)<0){return""}return"M"+e+","+g+"L"+f+","+h},convertRectangles:function(e,g,h,f){var e=parseFloat(e,10);var g=parseFloat(g,10);var h=parseFloat(h,10);var f=parseFloat(f,10);if(e<0||g<0||h<0||f<0){return""}return"M"+e+","+g+"L"+(e+h)+","+g+" "+(e+h)+","+(g+f)+" "+e+","+(g+f)+"z"}};var canvasObj={instance:null,imgs:[],fixedDrag:false,stage:null,layer:null,canvas:null,contourFinder:null,capturer:null,pathSum:0,pointSum:0,contextStates:null,init:function(f,j,g){this.stage=new Konva.Stage({container:f,width:j,height:g});var h=false;this.layer=new Konva.Layer();this.layer.canvas._canvas.className="canvas__panel";this.stage.add(this.layer);this.instance=this.layer.canvas._canvas;if(this.instance.addEventListener){document.onkeydown=function(a){var b=a.which||a.keyCode;if(b===16){this.fixedDrag=true}}.bind(this);document.onkeyup=function(a){var b=a.which||a.keyCode;if(b===16){this.fixedDrag=false}}.bind(this);var i=document.createElement("div");i.className="notice__drop";i.innerText="Drop the image";this.instance.parentElement.appendChild(i);this.instance.addEventListener("dragover",function(a){a.preventDefault();if(!h){i.style.opacity=1;h=true}},false);this.instance.addEventListener("dragleave",function(a){a.preventDefault();if(h){i.style.opacity=0;h=false}},false);this.instance.addEventListener("drop",function(b){if(h){i.style.opacity=0;h=false}var c=b.dataTransfer.files;if(c.length>0){var d=c[0];if(typeof FileReader!=="undefined"&&d.type.indexOf("image")!==-1){var e=new FileReader();var a=new FileReader();e.onload=function(m){var n=document.createElement("img");n.addEventListener("load",function(){const z=n.width/n.height;const v=0.8;var w=n.width;var k=n.height;if(n.width>v*parseInt(this.instance.getAttribute("width"))||n.height>v*parseInt(this.instance.getAttribute("height"))){const l=z/(parseInt(this.instance.getAttribute("width"))/parseInt(this.instance.getAttribute("height")));w=l<1?v*parseInt(this.instance.getAttribute("height"))*z:v*parseInt(this.instance.getAttribute("width"));k=l<1?v*parseInt(this.instance.getAttribute("height")):v*parseInt(this.instance.getAttribute("width"))/z}var u=new Konva.Image({width:w,height:k});u.on("mouseout",function(){document.body.style.cursor="default"});u.image(n);var x=new Konva.Group({x:(parseInt(this.instance.getAttribute("width"))-w)/2,y:(parseInt(this.instance.getAttribute("height"))-k)/2,draggable:true});x.add(u);this.addAnchor(x,0,0,"topLeft");this.addAnchor(x,w,0,"topRight");this.addAnchor(x,0,k,"bottomLeft");this.addAnchor(x,w,k,"bottomRight");x.on("dragmove",function(){var r=this.layer.get("Group");var o=r.length;for(var q=0;q<o;q++){r[q].opacity(1)}this.layer.draw();for(var q=0;q<x.children.length;q++){var p=x.children[q];if(p.className==="Circle"){if(p.attrs.visible===false){p.show();this.layer.draw()}}}}.bind(this));this.layer.add(x);this.layer.draw();var y=this.imgs.push({group:x,oriX:(parseInt(this.instance.getAttribute("width"))-w)/2,oriY:(parseInt(this.instance.getAttribute("height"))-k)/2,oriW:w,oriH:k,isSVG:false,svgPaths:[]})-1;a.onload=(function(o){return function(q){var M=[];var t=document.createElement("div");t.innerHTML=q.target.result.trim().split("\n").join("").split("	").join("");var S=t.childNodes;var R=S.length;var U=window.innerWidth;var Q=window.innerHeight;var V=0;var W=0;var T=U;var r=Q;function s(D){var I=D.childNodes;var B=I.length;if(B===0){return}var A=document.createElementNS("http://www.w3.org/2000/svg","path");for(var F=0;F<B;F++){switch(I[F].nodeName){case"path":var E=I[F].getAttribute("d");var H=E.split("M");var C=H.length;for(var G=0;G<C;G++){if(H[G]===""){continue}A.setAttribute("d","M"+H[G]);M.push(A.outerHTML)
}break;case"circle":A.setAttribute("d",pathConverter.convertCE(I[F].getAttribute("cx"),I[F].getAttribute("cy"),I[F].getAttribute("r")));M.push(A.outerHTML);break;case"ellipse":A.setAttribute("d",pathConverter.convertCE(I[F].getAttribute("cx"),I[F].getAttribute("cy"),I[F].getAttribute("rx"),I[F].getAttribute("ry")));M.push(A.outerHTML);break;case"polygon":A.setAttribute("d",pathConverter.convertPoly(I[F].getAttribute("points"),"polygon"));M.push(A.outerHTML);break;case"polyline":A.setAttribute("d",pathConverter.convertPoly(I[F].getAttribute("points")));M.push(A.outerHTML);break;case"line":A.setAttribute("d",pathConverter.convertLine(I[F].getAttribute("x1"),I[F].getAttribute("y1"),I[F].getAttribute("x2"),I[F].getAttribute("y2")));M.push(A.outerHTML);break;case"rect":A.setAttribute("d",pathConverter.convertRectangles(I[F].getAttribute("x"),I[F].getAttribute("y"),I[F].getAttribute("width"),I[F].getAttribute("height")));M.push(A.outerHTML);break;default:break}s(I[F])}}for(var O=0;O<R;O++){if(S[O].nodeName==="svg"){var X=S[O].getAttribute("width");var N=S[O].getAttribute("height");var P=S[O].getAttribute("viewBox");if(X){U=parseFloat(X.split("px").join(""),10);T=U}if(N){Q=parseFloat(N.split("px").join(""),10);r=Q}if(P){V=parseFloat(P.split(" ")[0],10);W=parseFloat(P.split(" ")[1],10);T=parseFloat(P.split(" ")[2],10);r=parseFloat(P.split(" ")[3],10)}s(S[O])}}if(M.length!==0){var p=this.imgs[y];p.isSVG=true;p.svgPaths=M;p.svgW=U;p.svgH=Q;p.viewBoxX=V;p.viewBoxY=W;p.viewBoxW=T;p.viewBoxH=r}}.bind(o)})(this);a.readAsText(d);u.on("mouseover",function(){document.body.style.cursor="move"}.bind(this))}.bind(this),false);n.src=m.target.result}.bind(this);e.readAsDataURL(d)}}b.preventDefault()}.bind(this))}else{if(this.instance.attachEvent){}}},addAnchor:function(i){var f=i.getStage();var j=i.getLayer();var g=arguments.length===4?new Konva.Circle({x:arguments[1],y:arguments[2],stroke:"#666",fill:"#ddd",strokeWidth:2,radius:8,name:arguments[3],draggable:true,dragOnTop:false}):arguments[1];var h=function(v){var e=1;var c=v.getParent();var b=c.get(".topLeft")[0];var s=c.get(".topRight")[0];var r=c.get(".bottomRight")[0];var d=c.get(".bottomLeft")[0];var t=c.get("Image")[0];t.position(b.position());var u=v.getX();var w=v.getY();switch(v.getName()){case"topLeft":var a=d.getY()-b.getY();var x=this.fixedDrag?a*t.attrs.width/t.attrs.height:s.getX()-b.getX();d.setX(this.fixedDrag?r.getX()-x:u);t.position({x:r.position().x-x,y:r.position().y-a});if(this.fixedDrag){b.setX(s.getX()-x)}s.setY(w);break;case"topRight":var a=d.getY()-b.getY();var x=this.fixedDrag?a*t.attrs.width/t.attrs.height:s.getX()-b.getX();r.setX(this.fixedDrag?d.getX()+x:u);if(this.fixedDrag){s.setX(b.getX()+x)}b.setY(w);break;case"bottomRight":var x=s.getX()-b.getX();var a=this.fixedDrag?x*t.attrs.height/t.attrs.width:d.getY()-b.getY();d.setY(this.fixedDrag?b.getY()+a:w);if(this.fixedDrag){r.setY(s.getY()+a)}s.setX(u);break;case"bottomLeft":var x=s.getX()-b.getX();var a=this.fixedDrag?x*t.attrs.height/t.attrs.width:d.getY()-b.getY();r.setY(this.fixedDrag?s.getY()+a:w);if(this.fixedDrag){d.setY(b.getY()+a)}b.setX(u);break}if(x&&a){t.width(x);t.height(a)}}.bind(this);g.on("dragmove",function(){h(g);this.layer.draw()}.bind(this));g.on("mousedown touchstart",function(){i.setDraggable(false);this.moveToTop()});g.on("dragend",function(){i.setDraggable(true);this.layer.draw()}.bind(this));g.on("mouseover",function(){var a=this.getLayer();document.body.style.cursor="pointer";g.setStrokeWidth(4);a.draw()});g.on("mouseout",function(){var a=this.getLayer();document.body.style.cursor="default";this.setStrokeWidth(2);a.draw()});i.add(g)},clearCanvas:function(d,e,f){d=d||this.instance.getContext("2d");e=e||this.instance.width;f=f||this.instance.height;d.clearRect(0,0,e,f)},process:function(af,L){time.clear();var k=this.layer.get("Group");for(var V=0;V<k.length;V++){k[V].opacity(1)}this.layer.draw();var K=this.imgs.length;time.start("Find Contours");for(var V=0;V<K;V++){if(!this.imgs[V].isSVG){this.canvas=new Canvas(this.instance,parseInt(this.instance.getAttribute("width")),parseInt(this.instance.getAttribute("height")));var ae=new Canny(this.canvas);var ab=new Filters(this.canvas);this.contourFinder=new ContourFinder();time.start("Gray Scale");this.canvas.setImgData(ab.grayscale());time.end("Gray Scale");time.start("Gaussian Blur");this.canvas.setImgData(ab.gaussianBlur(5,1));time.end("Gaussian Blur");time.start("Canny Grdient");this.canvas.setImgData(ae.gradient("sobel"));time.end("Canny Grdient");time.start("Canny non-Maximum Suppress");this.canvas.setImgData(ae.nonMaximumSuppress());time.end("Canny non-Maximum Suppress");time.start("Canny Hysteresis");this.canvas.setImgData(ae.hysteresis());time.end("Canny Hysteresis");break}}for(var V=0;V<K;V++){var J=0;var X=this.imgs[V];var ah=X.group;var aa=ah.attrs.x;var ac=ah.attrs.y;var M=ah.get("Image")[0];var N=M.attrs.x;var T=M.attrs.y;if(!X.isSVG){this.contourFinder.init(this.canvas.getCanvas(),aa+(typeof N==="undefined"?0:N)-J,ac+(typeof tgroupImgY==="undefined"?0:T)-J,M.attrs.width+J*2,M.attrs.height+J*2);
var Y=this.contourFinder.findContours();this.pathSum+=Y.length;X.paths=Y}else{X.dx=aa+(typeof N==="undefined"?0:N)-J;X.dy=ac+(typeof T==="undefined"?0:T)-J;this.pathSum+=X.svgPaths.length;X.paths=X.svgPaths}}time.end("Find Contours");time.mark('Contour Number: <span class="font-a10000 font-bold">'+this.pathSum+"</span>");var P=[];var W=0;var Z=0;for(var j=0;j<K;j++){var X=this.imgs[j];var R=X.paths.length;P[j]=[];for(var l=0;l<R;l++){var U=document.createElementNS("http://www.w3.org/2000/svg","path");if(!X.isSVG){var d=X.paths[l];var S=d.length;var O="M";for(var i=0;i<S;i+=1){O+=(d[i].x+W)+","+(d[i].y+Z)+"  ";this.pointSum++}U.setAttribute("d",O.trim())}else{var Q=document.createElement("div");Q.innerHTML=X.paths[l];U.setAttribute("d",Q.childNodes[0].getAttribute("d").trim().split("\n").join("").split("	").join(""))}P[j].push(U)}}af();if(P.length!==0){var ag=document.getElementById("process__type");var ad=ag.options[ag.selectedIndex].value;switch(ad){case"preview":time.start("Draw");this.preview(P,L);break;case"save":time.start("Draw");this.save(P,L);break;default:break}}},preview:function(d,c){this.drawContours(this.canvas,d,c)},save:function(d,c){this.drawContours(this.canvas,d,c,true)},canvasSaveState:function(e,c){if(c){f=c;f.getContext("2d").drawImage(e.canvas,0,0)}else{var f=document.createElement("canvas");f.width=e.canvas.width;f.height=e.canvas.height;f.getContext("2d").drawImage(e.canvas,0,0)}return f},canvasRestoreState:function(d,c){if(c){d.drawImage(c,0,0)}},drawContours:function(D,r,t,C){C=C||false;this.contextStates=null;for(var y=0;y<r.length;y++){r[y].sort(function(b,a){return a.getTotalLength()-b.getTotalLength()})}this.clearCanvas();var u=this.layer.getContext();var i=function(b,c){var d=this.layer.get("Group");for(var a=0;a<d.length;a++){if(a>c){d[a].opacity(0)}}d[c].opacity(b);this.layer.draw();if(this.contextStates){this.canvasRestoreState(u._context,this.contextStates)}}.bind(this);var s=8;var z=1000;var w=[];var E;if(C&&!this.capturer){this.capturer=new CCapture({verbose:false,display:false,framerate:z,format:"webm",frameLimit:0,bakckgroundColor:"#fff",onProcess:function(a){time.mark('Capturing Frame Number: <span class="font-a10000 font-bold">'+a+"</span>","frameCount")}})}var v=0.5;var B=null;var F={x:63,y:208,ele:document.getElementById("nib")};var A=function(d){this.clearCanvas();var b=this.imgs[d];var f=b.group;var c=f.get("Image")[0];var j=f.attrs.x;var a=f.attrs.y;var e=c.attrs.x;var g=c.attrs.y;u.beginPath();u.moveTo(w[0].x,w[0].y);for(var h=1;h<w.length;h++){u.lineTo(w[h].x,w[h].y)}if(B){this.canvasRestoreState(u._context,B)}u.stroke();B=this.canvasSaveState(u._context,B);if(this.contextStates){u.drawImage(this.contextStates,0,0)}u.drawImage(F.ele,w[h-1].x-F.x,w[h-1].y-F.y);if(this.capturer){this.capturer.capture(this.instance)}}.bind(this);var x=function(o){if(this.capturer){this.capturer.capture(this.instance)}if(B){if(this.contextStates){this.contextStates.getContext("2d").drawImage(B,0,0)}else{this.contextStates=B}}var m=0;for(var j=0;j<r.length;j++){m+=r[j].length}time.mark('Process: <span class="font-a10000 font-bold">'+((this.pathSum-m)/this.pathSum*98).toFixed(2)+"%</span>","process");if(r[o].length===0){var e=document.getElementById("process__draw-color").checked;var M=0;if(C){var k=function(){M+=e?0.01:1;i(e?M:0,o);if(this.capturer){this.capturer.capture(this.instance)}if(M>=1){if(typeof r[o+1]!=="undefined"){if(this.contextStates){this.contextStates.getContext("2d").drawImage(u._context.canvas,0,0)}x(o+1)}else{if(this.capturer){this.capturer.stop();this.capturer.save();this.capturer=null}time.end("Draw");t();time.mark('Process: <span class="font-a10000 font-bold">100%</span>',"process")}}else{requestAnimationFrame(k)}}.bind(this);k()}else{var N=setInterval(function(){M+=e?0.01:1;i(e?M:0,o);if(M>=1){if(typeof r[o+1]!=="undefined"){if(this.contextStates){this.contextStates.getContext("2d").drawImage(u._context.canvas,0,0)}x(o+1)}else{time.end("Draw");t();time.mark('Process: <span class="font-a10000 font-bold">100%</span>',"process")}clearInterval(N)}}.bind(this),1000/z)}return}var L=r[o].splice(0,1);B=null;u.lineWidth=v;u.strokeStyle="#000";var l=this.imgs[o];var c=L[0].getTotalLength();var q=200;var a=8;s=l.isSVG?(Math.ceil(c/q)>a?a:Math.ceil(c/q)):s;var d=l.dx;var f=l.dy;var h=l.group.get("Image")[0].attrs.width;var n=l.group.get("Image")[0].attrs.height;w=[];var b=function(J,K){var G=K.group.get("Image")[0];if(K.isSVG){var T=K.dx;var U=K.dy;var S=Math.max(K.oriW/K.svgW,K.oriH/K.svgH)*Math.min(K.svgW/K.viewBoxW,K.svgH/K.viewBoxH);var H=(G.attrs.width/K.oriW)*S;var I=(G.attrs.height/K.oriH)*S;J.x=J.x*H+T-K.viewBoxX*H;J.y=J.y*I+U-K.viewBoxY*I;J.x=J.x>=T&&J.x<=T+h?J.x:((J.x<T)?T:T+h);J.y=J.y>=U&&J.y<=U+n?J.y:((J.y<U)?U:U+n);w.push(J)}else{w.push(J)}}.bind(this);if(this.capturer){var p=0;var O=function(){var G=p++*s;if(G<=c){var H=L[0].getPointAtLength(G);b(H,l);A(o);requestAnimationFrame(O)}else{x(o)}};O()}else{var p=0;var g=setInterval(function(){var G=p++*s;if(G<=c){var H=L[0].getPointAtLength(G);
b(H,l);A(o)}else{clearInterval(g);x(o)}},1000/z)}}.bind(this);if(C){this.capturer.start()}x(0)}};(function(){const m=73;const r=window.innerWidth;const q=window.navigator.userAgent.toLowerCase().indexOf("micromessenger")>-1?window.innerHeight-m:window.innerHeight;document.querySelectorAll(".container")[0].style.height=q+"px";canvasObj.init(document.querySelectorAll(".container")[0],r-13*2-350,q*6/7);var o=document.getElementById("process__button");var l=document.getElementById("clear__button");var s=document.getElementById("process__draw-color");var p=document.querySelectorAll(".checkbox__color")[0];var t=function(){Object.assign(canvasObj,{canvas:null,contourFinder:null,pathSum:0,pointSum:0,contextStates:null});o.className="button button__inline button__disabled";o.removeEventListener("click",t);l.className="button button__inline button__disabled";l.removeEventListener("click",k);setTimeout(function(){var e=console;var c=document.querySelectorAll(".container__info")[0];var a=c.children.length;for(var b=0;b<a;b++){c.removeChild(c.children[0])}var d=new Promise(function(){for(var j=0;j<canvasObj.imgs.length;j++){var g=canvasObj.imgs[j].group.children.length;var h=0;for(var i=0;i<g;i++){var f=canvasObj.imgs[j].group.children[i];if(f.className==="Circle"){f.hide();canvasObj.layer.draw()}else{h++}}}canvasObj.process(function(){o.className="button button__inline";o.addEventListener("click",t)},function(){l.className="button button__inline";l.addEventListener("click",k)})})},500)};var k=function(){Object.assign(canvasObj,{imgs:[],canvas:null,contourFinder:null,pathSum:0,pointSum:0,contextStates:null});canvasObj.layer.destroyChildren().draw()};var n=function(){s.checked=!s.checked;p.className=!s.checked?"checkbox__color":"checkbox__color checkbox__color-selected"};o.addEventListener("click",t);l.addEventListener("click",k);p.addEventListener("click",n);s.addEventListener("change",function(){p.className=!this.checked?"checkbox__color":"checkbox__color checkbox__color-selected"})})();