// Generated by CoffeeScript 1.10.0
(function() {
  var AudioDevice, EventEmitter, NodeSpeakerDevice,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  EventEmitter = require('../core/events');

  AudioDevice = require('../device');

  NodeSpeakerDevice = (function(superClass) {
    var Readable, Speaker;

    extend(NodeSpeakerDevice, superClass);

    AudioDevice.register(NodeSpeakerDevice);

    try {
      Speaker = require('speaker');
      Readable = require('stream').Readable;
    } catch (undefined) {}

    NodeSpeakerDevice.supported = Speaker != null;

    function NodeSpeakerDevice(sampleRate, channels) {
      this.sampleRate = sampleRate;
      this.channels = channels;
      this.refill = bind(this.refill, this);
      this.speaker = new Speaker({
        channels: this.channels,
        sampleRate: this.sampleRate,
        bitDepth: 32,
        float: true,
        signed: true
      });
      this.buffer = null;
      this.currentFrame = 0;
      this.ended = false;
      this.input = new Readable;
      this.input._read = this.refill;
      this.input.pipe(this.speaker);
    }

    NodeSpeakerDevice.prototype.refill = function(n) {
      var arr, buffer, frame, i, len, len1, offset;
      buffer = this.buffer;
      len = n / 4;
      arr = new Float32Array(len);
      this.emit('refill', arr);
      if (this.ended) {
        return;
      }
      if ((buffer != null ? buffer.length : void 0) !== n) {
        this.buffer = buffer = new Buffer(n);
      }
      offset = 0;
      for (i = 0, len1 = arr.length; i < len1; i++) {
        frame = arr[i];
        buffer.writeFloatLE(frame, offset);
        offset += 4;
      }
      this.input.push(buffer);
      return this.currentFrame += len / this.channels;
    };

    NodeSpeakerDevice.prototype.destroy = function() {
      this.ended = true;
      return this.input.push(null);
    };

    NodeSpeakerDevice.prototype.getDeviceTime = function() {
      return this.currentFrame;
    };

    return NodeSpeakerDevice;

  })(EventEmitter);

}).call(this);
